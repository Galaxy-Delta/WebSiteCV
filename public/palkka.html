<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeltaINC — Payroll Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <!-- ===== LOGO ===== -->
  <div class="logo">DeltaINC</div>

 <!-- ===== NAVIGAATIO ===== -->
<div class="navbar">
  <!-- --- HomePage --- -->
  <div class="dropdown">
    <button class="dropbtn">HomePage</button>
    <div class="dropdown-content">
      <a href="/OmaWEB.html">HomePage</a>
    </div>
  </div>

  <!-- --- Blender --- -->
  <div class="dropdown">
    <button class="dropbtn">Blender</button>
    <div class="dropdown-content">
      <a href="/blender.html">Projects</a>
    </div>
  </div>
  
  <!-- --- CV --- -->
  <div class="dropdown">
    <button class="dropbtn">CV</button>
    <div class="dropdown-content">
      <a href="/cv.html">CV</a>
    </div>
  </div>

  <!-- --- Projects --- -->
  <div class="dropdown">
    <button class="dropbtn">Projects</button>
    <div class="dropdown-content">
      <a href="/pro.html">Gameprojects</a>
      <a href="https://galaxy-delta.itch.io/" target="_blank" rel="noopener">Itchio-page</a>
    </div>
  </div>
<!---TOOLS--->
   <div class="dropdown">
    <button class="dropbtn">Tools</button>
    <div class="dropdown-content">
      <a href="/budget.html">Budget Planner</a>
      <a href="/palkka.html">Payroll caculator</a>
    </div>
  </div>

  <!-- --- Social --- -->
  <div class="dropdown">
    <button class="dropbtn">Social Media</button>
    <div class="dropdown-content">
      <a href="https://www.youtube.com/@PelataanJ/videos" target="_blank" rel="noopener">YouTube</a>
      <a href="https://www.twitch.tv/galaxy_delta" target="_blank" rel="noopener">Twitch</a>
    </div>
  </div>

  <!-- --- Contact --- -->
  <div class="dropdown">
    <button class="dropbtn">Contact me</button>
    <div class="dropdown-content">
      <a href="mailto:jep.knuutinen@gmail.com">E-mail</a>
    </div>
  </div>
</div>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#111; --panel:#171717; --muted:#232323; --text:#eee; --subtle:#bbb; --line:#333;
      --ok:#a3e635; --warn:#fbbf24; --bad:#fb7185; --accent:#60a5fa;
    }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:600;margin:0 0 6px}
    input{width:100%;box-sizing:border-box;background:#0e0e0e;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}
    .row{display:flex;gap:10px}
    .row > div{flex:1}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    button{background:var(--muted);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:#3a78d6;color:#071422;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    #status{min-height:20px;color:var(--subtle)}
    table{width:100%;border-collapse:collapse;background:#0e0e0e}
    th, td{padding:10px;border:1px solid var(--line);text-align:left}
    th{background:#121212}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DeltaINC — Payroll Calculator</h1>

    <form id="payForm" class="card">
      <div class="grid">
        <div>
          <label for="hourly">Hourly Wages (€ / h)</label>
          <input id="hourly" type="number" step="0.01" value="13.50" required>
        </div>

        <div>
          <label for="hReg">Basic Hours</label>
          <input id="hReg" type="number" step="0.1" value="120" required>
        </div>

        <div>
          <label for="hEve">Afternoon Hours</label>
          <input id="hEve" type="number" step="0.1" value="10">
        </div>
        <div>
          <label for="aEve">Afternoon Add (€ / h)</label>
          <input id="aEve" type="number" step="0.01" value="1.15">
        </div>

        <div>
          <label for="hNig">Night Hours</label>
          <input id="hNig" type="number" step="0.1" value="8">
        </div>
        <div>
          <label for="aNig">Night Add (€ / h)</label>
          <input id="aNig" type="number" step="0.01" value="2.30">
        </div>

        <div>
          <label for="hWkd">Weekend Hours</label>
          <input id="hWkd" type="number" step="0.1" value="12">
        </div>
        <div>
          <label for="aWkd">Weekend Add (€ / h)</label>
          <input id="aWkd" type="number" step="0.01" value="3.90">
        </div>

        <div>
          <label for="taxPct">Tax Percent (%)</label>
          <input id="taxPct" type="number" step="0.01" value="18" required>
        </div>

        <div>
          <label for="period">Period (e.g. 2025-09)</label>
          <input id="period" type="text" value="2025-09">
        </div>
      </div>

      <div class="btns">
        <button type="button" id="calcBtn">Calculate</button>
        <button type="reset" id="resetBtn">Reset</button>
        <button type="button" class="primary" id="saveBtn">SAVE AND PROCEED</button>
      </div>
      <div id="status"></div>
    </form>

    <div id="out" class="card hidden">
      <h2>Results</h2>
      <table id="resultTable">
        <thead><tr><th>Row</th><th>Value</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Tiny helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    // ===== Compute model from inputs
    function readNum(id){ return Number(document.getElementById(id).value || 0); }
    function readStr(id){ return String(document.getElementById(id).value || ''); }

    function compute(){
      const m = {
        hourly: readNum('hourly'),
        hReg:   readNum('hReg'),
        hEve:   readNum('hEve'),
        aEve:   readNum('aEve'),
        hNig:   readNum('hNig'),
        aNig:   readNum('aNig'),
        hWkd:   readNum('hWkd'),
        aWkd:   readNum('aWkd'),
        taxPct: readNum('taxPct'),
        period: readStr('period')
      };

      m.basePay = m.hourly * m.hReg;
      m.addPay  = (m.hEve * m.aEve) + (m.hNig * m.aNig) + (m.hWkd * m.aWkd);
      m.gross   = m.basePay + m.addPay;
      m.taxAmt  = m.gross * (m.taxPct/100);
      m.net     = m.gross - m.taxAmt;

      return m;
    }

    // ===== Render results into table
    function renderResults(m){
      const rows = [
        ['Hourly Wages', `${m.hourly.toFixed(2)} €/h`],
        ['Basic Hours', `${m.hReg}`],
        ['Afternoon Hours (+€)', `${m.hEve} @ ${m.aEve.toFixed(2)} €/h`],
        ['Nightshift (+€)', `${m.hNig} @ ${m.aNig.toFixed(2)} €/h`],
        ['Weekend Hours (+€)', `${m.hWkd} @ ${m.aWkd.toFixed(2)} €/h`],
        ['Tax Percent', `${m.taxPct}%`],
        ['Basic salary', `${m.basePay.toFixed(2)} €`],
        ['Extra hours', `${m.addPay.toFixed(2)} €`],
        ['Gross salary', `${m.gross.toFixed(2)} €`],
        ['Tax', `${m.taxAmt.toFixed(2)} €`],
        ['Net income (estimate)', `${m.net.toFixed(2)} €`],
      ];

      const tbody = $('#resultTable tbody');
      tbody.innerHTML = '';
      for(const [k,v] of rows){
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = k;
        const td2 = document.createElement('td'); td2.textContent = v;
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
      }
      $('#out').classList.remove('hidden');
    }

    // ===== Create PDF and return Base64 (no data: prefix)
    async function makePdf(m){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      doc.setFontSize(18);
      doc.text('Payroll Summary — DeltaINC', 40, 40);

      const rows = [
        ['Hourly Wages', `${m.hourly.toFixed(2)} €/h`],
        ['Basic Hours', `${m.hReg}`],
        ['Afternoon Hours (+€)', `${m.hEve} @ ${m.aEve.toFixed(2)} €/h`],
        ['Nightshift (+€)', `${m.hNig} @ ${m.aNig.toFixed(2)} €/h`],
        ['Weekend Hours (+€)', `${m.hWkd} @ ${m.aWkd.toFixed(2)} €/h`],
        ['Tax Percent', `${m.taxPct}%`],
        ['Basic salary', `${m.basePay.toFixed(2)} €`],
        ['Extra hours', `${m.addPay.toFixed(2)} €`],
        ['Gross salary', `${m.gross.toFixed(2)} €`],
        ['Tax', `${m.taxAmt.toFixed(2)} €`],
        ['Net income (estimate)', `${m.net.toFixed(2)} €`],
      ];

      doc.autoTable({
        startY: 60,
        head: [['Row', 'Value']],
        body: rows,
        theme: 'grid'
      });

      const fname = `Payroll_${(m.period || 'period')}_${Date.now()}.pdf`;
      doc.save(fname);

      // Base64 without the "data:application/pdf;base64," prefix
      const dataUri = doc.output('datauristring');
      const base64 = dataUri.split(',')[1] || '';
      return base64;
    }

    // ===== POST to backend
    async function postToBackend(payload){
      const BACKEND_URL = 'https://websitecv-nrv1.onrender.com/save.php';
      const res = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        throw new Error(`Save failed! ${res.status} ${txt}`);
      }
      return res.json().catch(()=> ({}));
    }

    // ===== UI wiring
    $('#calcBtn').addEventListener('click', () => {
      const m = compute();
      renderResults(m);
      $('#status').textContent = 'Calculated.';
    });

    $('#resetBtn').addEventListener('click', () => {
      $('#out').classList.add('hidden');
      $('#status').textContent = '';
    });

    $('#saveBtn').addEventListener('click', async () => {
      const btn = $('#saveBtn');
      const status = $('#status');
      try{
        btn.disabled = true;
        status.textContent = 'Generating PDF and saving...';

        const model = compute();
        renderResults(model);
        const pdfB64 = await makePdf(model);

        const payload = {
          kind: 'PayCalculator',
          meta: { app: 'DeltaINC PayCalculator', version: '1.0.0' },
          model,
          pdf_base64: pdfB64
        };

        await postToBackend(payload);
        status.textContent = 'Saved to backend and downloaded PDF.';
        alert('Saved to backend and downloaded PDF.');
      }catch(err){
        console.error(err);
        status.textContent = err.message || 'Unknown error on save';
        alert(err.message || 'Unknown error on save');
      }finally{
        btn.disabled = false;
      }
    });

    // Prevent default form submit (we handle via buttons)
    $('#payForm').addEventListener('submit', (e)=> e.preventDefault());
  </script>
</body>
</html>
