<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeltaINC — Payroll Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#111; --panel:#171717; --muted:#232323; --text:#eee; --subtle:#bbb; --line:#333;
      --ok:#a3e635; --warn:#fbbf24; --bad:#fb7185; --accent:#60a5fa;
    }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    .logo{font-weight:800;font-size:32px;letter-spacing:.08em;opacity:.9;margin:16px 0}
    .navbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
    .dropdown{position:relative}
    .dropbtn{background:var(--muted);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .dropdown-content{display:none;position:absolute;background:var(--panel);border:1px solid var(--line);min-width:180px;border-radius:10px;padding:6px}
    .dropdown:hover .dropdown-content{display:block}
    .dropdown-content a{display:block;color:var(--text);text-decoration:none;padding:6px 8px;border-radius:8px}
    .dropdown-content a:hover{background:#0e0e0e}

    h1{font-size:24px;margin:0 0 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:600;margin:0 0 6px}
    input{width:100%;box-sizing:border-box;background:#0e0e0e;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}
    .row{display:flex;gap:10px}
    .row > div{flex:1}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    button{background:var(--muted);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:#3a78d6;color:#071422;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    #status{min-height:20px;color:var(--subtle)}
    table{width:100%;border-collapse:collapse;background:#0e0e0e}
    th, td{padding:10px;border:1px solid var(--line);text-align:left}
    th{background:#121212}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">DeltaINC</div>

  <div class="navbar">
    <!--- MAIN --->
    <div class="dropdown"><button class="dropbtn">HomePage</button>
      <div class="dropdown-content"><a href="/OmaWEB.html">HomePage</a>
      </div>
    </div>
    <!--- BLENDER --->
    <div class="dropdown">
      <button class="dropbtn">Blender</button>
      <div class="dropdown-content">
        <a href="/blender.html">Projects</a>
      </div>
    </div>
    <!---CV--->
    <div class="dropdown">
      <button class="dropbtn">CV</button>
      <div class="dropdown-content">
        <a href="/cv.html">CV</a>
      </div>
    </div>
    <!---PROJECTS--->
    <div class="dropdown">
      <button class="dropbtn">Projects</button>
      <div class="dropdown-content">
        <a href="/pro.html">Gameprojects</a>
        <a href="https://galaxy-delta.itch.io/" target="_blank" rel="noopener">Itchio-page</a>
      </div>
    </div>
    <!---TOOLS--->
    <div class="dropdown">
    <button class="dropbtn">Tools</button>
    <div class="dropdown-content">
      <a href="/budget.html">Budget Planner</a>
      <a href="/palkka.html">Payroll caculator</a>
    </div>
  </div>
    <!---SOME--->
    <div class="dropdown">
      <button class="dropbtn">Social Media</button>
      <div class="dropdown-content">
        <a href="https://www.youtube.com/@PelataanJ/videos" target="_blank" rel="noopener">YouTube</a>
        <a href="https://www.twitch.tv/galaxy_delta" target="_blank" rel="noopener">Twitch</a>
      </div>
    </div>
    <!---E-Mail--->
    <div class="dropdown">
      <button class="dropbtn">Contact me</button>
      <div class="dropdown-content">
        <a href="mailto:jep.knuutinen@gmail.com">E-mail</a>
      </div>
    </div>
  </div>

    <!-- ===== TITLE ===== -->
    <h1>Payroll Calculator</h1>

    <!-- ===== STEP 1: FORM ===== -->
    <form id="payForm" class="card">
      <div class="grid">
        <div><label for="hourly">Hourly Wages (€ / h)</label><input id="hourly" type="number" step="0.01" value="13.50" required></div>
        <div><label for="hReg">Basic Hours</label><input id="hReg" type="number" step="0.1" value="120" required></div>
        <div><label for="hEve">Afternoon Hours</label><input id="hEve" type="number" step="0.1" value="10"></div>
        <div><label for="aEve">Afternoon Add (€ / h)</label><input id="aEve" type="number" step="0.01" value="1.15"></div>
        <div><label for="hNig">Night Hours</label><input id="hNig" type="number" step="0.1" value="8"></div>
        <div><label for="aNig">Night Add (€ / h)</label><input id="aNig" type="number" step="0.01" value="2.30"></div>
        <div><label for="hWkd">Weekend Hours</label><input id="hWkd" type="number" step="0.1" value="12"></div>
        <div><label for="aWkd">Weekend Add (€ / h)</label><input id="aWkd" type="number" step="0.01" value="3.90"></div>
        <div><label for="taxPct">Tax Percent (%)</label><input id="taxPct" type="number" step="0.01" value="18" required></div>
        <div><label for="period">Period (e.g. 2025-09)</label><input id="period" type="text" value="2025-09"></div>
      </div>
      <div class="btns">
        <button type="button" id="calcBtn">Calculate</button>
        <button type="reset" id="resetBtn">Reset</button>
        <button type="button" class="primary" id="saveBtn">SAVE AND PROCEED</button>
      </div>
      <div id="status"></div>
    </form>

    <!-- ===== STEP 2: GATE ===== -->
    <div id="gate" class="card hidden">
      <h2>Saved ✅</h2>
      <p>
        Data was saved to <code>data/palkka/…</code>. Click <strong>Continue</strong> to proceed.
      </p>
      <button id="continueBtn" class="primary">Continue</button>
      <div id="gateStatus" class="subtle"></div>
    </div>

    <!-- ===== STEP 3A: POST-ACTIONS (no results yet) ===== -->
    <div id="post" class="card hidden">
      <h2>Next steps</h2>
      <p>Choose what you want to do next.</p>
      <div class="btns">
        <button id="showResultsBtn" class="primary">SHOW RESULTS</button>
        <button id="downloadPdfBtn">DOWNLOAD PDF</button>
      </div>
      <div id="postStatus" class="subtle"></div>
    </div>

    <!-- ===== STEP 3B: RESULTS (shown only after SHOW RESULTS) ===== -->
    <div id="out" class="card hidden">
      <h2>Results</h2>
      <table id="resultTable">
        <thead><tr><th>Row</th><th>Value</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    //==== BACKENDS ====
    const BACKEND_URL = "https://websitecv-nrv1.onrender.com/save-payroll.php"; // saves to data/palkka + returns path
    const BACKEND_GH_URL = "https://websitecv-nrv1.onrender.com/save-github.php"; // silent GitHub commit

    // ===== Helpers =====
    const $ = (s) => document.querySelector(s);
    const statusEl = document.getElementById('status');
    const gateStatus = document.getElementById('gateStatus');
    const postStatus = document.getElementById('postStatus');

    function readNum(id){ return Number(document.getElementById(id).value || 0); }
    function readStr(id){ return String(document.getElementById(id).value || ''); }

    // ===== Compute model from inputs =====
    function compute(){
      const m = {
        hourly: readNum('hourly'),
        hReg:   readNum('hReg'),
        hEve:   readNum('hEve'),
        aEve:   readNum('aEve'),
        hNig:   readNum('hNig'),
        aNig:   readNum('aNig'),
        hWkd:   readNum('hWkd'),
        aWkd:   readNum('aWkd'),
        taxPct: readNum('taxPct'),
        period: readStr('period')
      };
      m.basePay = m.hourly * m.hReg;
      m.addPay  = (m.hEve * m.aEve) + (m.hNig * m.aNig) + (m.hWkd * m.aWkd);
      m.gross   = m.basePay + m.addPay;
      m.taxAmt  = m.gross * (m.taxPct/100);
      m.net     = m.gross - m.taxAmt;
      return m;
    }

    // ===== Results table =====
    function renderResults(m){
      const rows = [
        ['Hourly Wages', `${m.hourly.toFixed(2)} €/h`],
        ['Basic Hours', `${m.hReg}`],
        ['Afternoon Hours (+€)', `${m.hEve} @ ${m.aEve.toFixed(2)} €/h`],
        ['Nightshift (+€)', `${m.hNig} @ ${m.aNig.toFixed(2)} €/h`],
        ['Weekend Hours (+€)', `${m.hWkd} @ ${m.aWkd.toFixed(2)} €/h`],
        ['Tax Percent', `${m.taxPct}%`],
        ['Basic salary', `${m.basePay.toFixed(2)} €`],
        ['Extra hours', `${m.addPay.toFixed(2)} €`],
        ['Gross salary', `${m.gross.toFixed(2)} €`],
        ['Tax', `${m.taxAmt.toFixed(2)} €`],
        ['Net income (estimate)', `${m.net.toFixed(2)} €`],
      ];
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      for(const [k,v] of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
        tbody.appendChild(tr);
      }
    }

    // ===== PDF generation =====
    function stylePayrollPDF(doc, m){
      doc.setFontSize(18);
      doc.text('Payroll Summary — DeltaINC', 40, 40);
      doc.setFontSize(10);
      doc.text(`Period: ${m.period || '—'}`, 40, 58);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 72);
    }

    async function buildPdfAndReturnBase64(m){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      stylePayrollPDF(doc, m);
      const rows = [
        ['Hourly Wages', `${m.hourly.toFixed(2)} €/h`],
        ['Basic Hours', `${m.hReg}`],
        ['Afternoon Hours (+€)', `${m.hEve} @ ${m.aEve.toFixed(2)} €/h`],
        ['Nightshift (+€)', `${m.hNig} @ ${m.aNig.toFixed(2)} €/h`],
        ['Weekend Hours (+€)', `${m.hWkd} @ ${m.aWkd.toFixed(2)} €/h`],
        ['Tax Percent', `${m.taxPct}%`],
        ['Basic salary', `${m.basePay.toFixed(2)} €`],
        ['Extra hours', `${m.addPay.toFixed(2)} €`],
        ['Gross salary', `${m.gross.toFixed(2)} €`],
        ['Tax', `${m.taxAmt.toFixed(2)} €`],
        ['Net income (estimate)', `${m.net.toFixed(2)} €`],
      ];
      doc.autoTable({ startY: 90, head: [['Row', 'Value']], body: rows, theme: 'grid' });
      const dataUri = doc.output('datauristring');
      return {
        filename: `Payroll_${(m.period||'period')}_${Date.now()}.pdf`,
        base64: dataUri.split(',')[1] || ''
      };
    }

    // ===== UI wiring =====
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveBtn = document.getElementById('saveBtn');
    const continueBtn = document.getElementById('continueBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const showResultsBtn = document.getElementById('showResultsBtn');

    let lastPdfName = null;
    let lastPdfBase64 = null;
    let lastModel = null; // used after Continue

    calcBtn.onclick = () => {
      const m = compute();
      renderResults(m);
      document.getElementById('out').classList.remove('hidden');
      statusEl.textContent = 'Calculated.';
    };

    resetBtn.onclick = () => {
      document.getElementById('out').classList.add('hidden');
      document.getElementById('gate').classList.add('hidden');
      document.getElementById('post').classList.add('hidden');
      document.getElementById('payForm').classList.remove('hidden');
      statusEl.textContent = '';
      gateStatus.textContent = '';
      postStatus.textContent = '';
      lastPdfBase64 = null;
      lastPdfName = null;
      lastModel = null;
    };

    // === SAVE & PROCEED (Step 1): save to backend (data/palkka/...), then show gate ===
    saveBtn.onclick = async () => {
      try{
        saveBtn.disabled = true;
        statusEl.textContent = 'Generating PDF and saving...';

        const model = compute();
        const pdf = await buildPdfAndReturnBase64(model);
        lastPdfName = pdf.filename;
        lastPdfBase64 = pdf.base64;
        lastModel = model;

        const payload = {
          kind: 'PayCalculator',
          meta: { app: 'DeltaINC PayCalculator', version: '1.0.0' },
          model,
          pdf_base64: pdf.base64,
          pdf_filename: pdf.filename
        };

        const res = await fetch(BACKEND_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data?.error || `Save failed (${res.status})`);

        statusEl.textContent = `Saved to: ${data?.saved_dir || 'data/palkka/...'} \u2714\uFE0F`;
        document.getElementById('gate').classList.remove('hidden');
      }catch(e){
        console.error(e);
        statusEl.textContent = `\u274C ${e.message || 'Unknown error on save'}`;
      }finally{
        saveBtn.disabled = false;
      }
    };

    // === SILENT GITHUB SAVE (await + status) ===
    async function silentGithubSave(){
      try{
        if(!lastModel){ lastModel = compute(); }
        if(!lastPdfBase64){
          const pdf = await buildPdfAndReturnBase64(lastModel);
          lastPdfName = pdf.filename;
          lastPdfBase64 = pdf.base64;
        }
        const ghPayload = {
          model: lastModel,
          pdf_base64: lastPdfBase64,
          pdf_filename: lastPdfName
        };
        gateStatus.textContent = 'Committing to GitHub (DATA folder)…';
        const r = await fetch(BACKEND_GH_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ghPayload)
        });
        if(!r.ok){ throw new Error(`GitHub save failed (${r.status})`); }
        gateStatus.textContent = 'Saved to GitHub ✅';
      }catch(err){
        console.debug('Silent GitHub save failed:', err);
        gateStatus.textContent = 'GitHub save failed (continuing anyway).';
      }
    }

    // === CONTINUE: do GitHub save, then show the "Next steps" screen with two buttons ===
    continueBtn.onclick = async () => {
      await silentGithubSave();
      document.getElementById('payForm').classList.add('hidden');
      document.getElementById('gate').classList.add('hidden');
      document.getElementById('out').classList.add('hidden');
      document.getElementById('post').classList.remove('hidden');
    };

    // === SHOW RESULTS (only reveals the table) ===
    showResultsBtn.onclick = () => {
      const m = lastModel || compute();
      renderResults(m);
      document.getElementById('out').classList.remove('hidden');
      postStatus.textContent = 'Results shown below.';
    };

    // === DOWNLOAD PDF (available on the separate post screen) ===
    downloadPdfBtn.onclick = () => {
      const ensureDownload = async () => {
        if(!lastPdfBase64){
          const m = compute();
          const pdf = await buildPdfAndReturnBase64(m);
          lastPdfName = pdf.filename; lastPdfBase64 = pdf.base64;
        }
        const link = document.createElement('a');
        link.href = `data:application/pdf;base64,${lastPdfBase64}`;
        link.download = lastPdfName || 'Payroll.pdf';
        document.body.appendChild(link); link.click(); link.remove();
        postStatus.textContent = 'PDF downloaded.';
      };
      ensureDownload();
    };

    // Prevent default form submit
    document.getElementById('payForm').addEventListener('submit', (e)=> e.preventDefault());
  </script>
</body>
</html>
