<!DOCTYPE html>
saveBtn.onclick = async () => {
try{
saveBtn.disabled = true;
statusEl.textContent = 'Generating PDF and saving...';


const model = compute();
const pdf = await buildPdfAndReturnBase64(model);
lastPdfName = pdf.filename;
lastPdfBase64 = pdf.base64;


const payload = {
kind: 'PayCalculator',
meta: { app: 'DeltaINC PayCalculator', version: '1.0.0' },
model,
pdf_base64: pdf.base64,
pdf_filename: pdf.filename
};


const res = await fetch(BACKEND_URL, {
method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
});
const data = await res.json().catch(()=>({}));
if(!res.ok) throw new Error(data?.error || `Save failed (${res.status})`);


statusEl.textContent = `Saved to: ${data?.saved_dir || 'data/palkka/...'} \u2714\uFE0F`;
// Show the gate (Continue). Do not show results yet.
document.getElementById('gate').classList.remove('hidden');
}catch(e){
console.error(e);
statusEl.textContent = `\u274C ${e.message || 'Unknown error on save'}`;
}finally{
saveBtn.disabled = false;
}
};


// === CONTINUE: now reveal results-only view
continueBtn.onclick = () => {
const m = compute();
renderResults(m);
document.getElementById('payForm').classList.add('hidden');
document.getElementById('gate').classList.add('hidden');
document.getElementById('out').classList.remove('hidden');
};


// === DOWNLOAD PDF (client-side copy)
downloadPdfBtn.onclick = () => {
// if we have lastPdfBase64 (from the save step), we reuse it; else regen.
const ensureDownload = async () => {
if(!lastPdfBase64){
const m = compute();
const pdf = await buildPdfAndReturnBase64(m);
lastPdfName = pdf.filename; lastPdfBase64 = pdf.base64;
}
const link = document.createElement('a');
link.href = `data:application/pdf;base64,${lastPdfBase64}`;
link.download = lastPdfName || 'Payroll.pdf';
document.body.appendChild(link); link.click(); link.remove();
};
ensureDownload();
};


// Prevent default form submit
document.getElementById('payForm').addEventListener('submit', (e)=> e.preventDefault());
</script>
</body>
</html>
